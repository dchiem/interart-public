
<style>
  #sketch{
    width:957px;
    height:950px;
    border:1px solid black;
    background-size:cover;
  }

  #comment-field{
    width:500px;
    height:100px;
  }

  #comment{
    margin-top:30px;
  }
</style>
<div id="annotate">
  <div id="options">
    <%= form_tag do %>
      <%= submit_tag "black", :class => "color", :id => "black" %>
      <%= submit_tag "purple", :class => "color", :id => "purple" %>
      <%= submit_tag "green", :class => "color", :id => "green" %>
      <%= submit_tag "yellow", :class => "color", :id => "yellow" %>
      <%= submit_tag "brown", :class => "color", :id => "brown" %>
      <%= submit_tag "small", :class => "size", :id => "small" %>
      <%= submit_tag "medium", :class => "size", :id => "medium" %>
      <%= submit_tag "large", :class => "size", :id => "large" %>
      <%= submit_tag "huge", :class => "size", :id => "huge" %>
      <%= submit_tag "marker", :class => "tool", :id => "marker" %>
      <%= submit_tag "eraser", :class => "tool", :id => "eraser" %>
    <% end %>
  </div>
  <div id="sketch">
  <canvas id="paint"></canvas>
</div>
<div id="comment">
  <%= form_tag "/pieces/annotate_submit" do %>
  <%= hidden_field_tag :piece_version_id, @piece_version.id %>
  <%= hidden_field_tag :piece_id, @piece_version.piece.id %>
    <div>Comments:</div>
    <div><%= text_area_tag :comment, nil, :id => "comment-field" %></div>
    <div><%= submit_tag "Save comment", :style => "margin-bottom:100px;", :id => 'save' %></div>
  <% end %>
</div>
</div>

<script type="text/javascript">




// ******************************************************



// $('#sketch')[0].style.backgroundImage = 'url(<%= @piece_version.url %>)';
// $('#sketch')[0].style.backgroundPosition = "center";

  
function imageLoaded(){
  canvas.width = 800;
  canvas.height = 800;
  
  canvas.getContext("2d").drawImage(image, 0, 0,800,800);
  var context = canvas.getContext('2d');
   
  var sketch = document.querySelector('#sketch');



$('#sketch').touchstart(function(e){
  var mouseX = e.pageX - this.offsetLeft;
  var mouseY = e.pageY - this.offsetTop;
    
  paint = true;
  addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
  redraw();
});

$('#sketch').touchmove(function(e){
  if(paint){
    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
    redraw();
  }
});

$('#sketch').touchend(function(e){
  paint = false;
});


$('#sketch').mousedown(function(e){
  var mouseX = e.pageX - this.offsetLeft;
  var mouseY = e.pageY - this.offsetTop;
    
  paint = true;
  addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
  redraw();
});

$('#sketch').mousemove(function(e){
  if(paint){
    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
    redraw();
  }
});

$('#sketch').mouseup(function(e){
  paint = false;
});

$('#sketch').mouseleave(function(e){
  paint = false;
});

var clickX = new Array();
var clickY = new Array();
var clickDrag = new Array();
var paint;

function addClick(x, y, dragging)
{
  clickX.push(x);
  clickY.push(y);
  clickDrag.push(dragging);
  if(curTool === "eraser"){
    clickColor.push("white");
  } else {
    clickColor.push(curColor);
  }
   clickSize.push(curSize);
}

function redraw(){
  // context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
  
  // context.strokeStyle = "#df4b26";
  context.lineJoin = "round";
  
      
  for(var i=0; i < clickX.length; i++) {    
    context.beginPath();
    if(clickDrag[i] && i){
      context.moveTo(clickX[i-1], clickY[i-1]);
     }else{
       context.moveTo(clickX[i]-1, clickY[i]);
     }
     context.lineTo(clickX[i], clickY[i]);
     context.closePath();
     context.strokeStyle = clickColor[i];
     context.stroke();
     context.lineWidth = clickSize[i];
  }
}





var colorPurple = "#cb3594";
var colorGreen = "#659b41";
var colorYellow = "#ffcf33";
var colorBrown = "#986928";
var colorBlack = "#000000";

var curColor = colorBlack;
var clickColor = new Array();
var clickSize = new Array();
var curSize = 4;

var clickTool = new Array();
var curTool = "marker";

$(".size").click(function(){
  var id = $(this).attr("id");
  if(id === "small"){
    curSize = 1;
  } else if (id === "medium"){
    curSize = 4;
  } else if (id === "large"){
    curSize = 9;
  } else if (id === "huge"){
    curSize = 14;
  }
  return false;
});
    


$(".color").click(function(){
  var id = $(this).attr("id");
  if(id === "black"){
    curColor = colorBlack;
  } else if(id === "purple"){
curColor = colorPurple;
  } else if(id === "green"){
    curColor = colorGreen;
  } else if(id === "yellow"){
    curColor = colorYellow;
  } else if(id === "brown"){
    curColor = colorBrown;
  }
  return false;
});
    
$(".tool").click(function(){
  var id = $(this).attr("id");
  if(id === "marker"){
    curTool = "marker";
  }else if(id === "eraser"){
    curTool = "eraser";
  }
  return false;
});
    

  // var sketch_style = getComputedStyle(sketch);
  
//  var mouse = {x: 0, y: 0};
//   var last_mouse = {x: 0, y: 0};
   
//   /* Mouse Capturing Work */
//   canvas.addEventListener('mousemove', function(e) {
//       last_mouse.x = mouse.x;
//       last_mouse.y = mouse.y;
   
//       mouse.x = e.pageX - this.offsetLeft;
//       mouse.y = e.pageY - this.offsetTop;
//   }, false);
  
//    //Drawing on Paint App 
//   ctx.lineWidth = 5;
//   ctx.lineJoin = 'round';
//   ctx.lineCap = 'round';
//   ctx.strokeStyle = 'black';
   
//   canvas.addEventListener('mousedown', function(e) {
//       ctx.beginPath();
//       ctx.moveTo(mouse.x, mouse.y);
   
//       canvas.addEventListener('mousemove', onPaint, false);
//   }, false);
   
//   canvas.addEventListener('mouseup', function() {
//       canvas.removeEventListener('mousemove', onPaint, false);
//   }, false);
   
//   var onPaint = function() {
//     ctx.beginPath();
//     ctx.moveTo(last_mouse.x, last_mouse.y);
//     ctx.lineTo(mouse.x, mouse.y);
//     ctx.closePath();
//     ctx.stroke();
// };

  

}

$(document).ready(function(){
  canvas = document.querySelector('#paint');
  image = new Image();

  image.onload = imageLoaded;
  image.crossOrigin = 'anonymous';
  // image.src = "<%= @piece_version.url %>";
  image.src = "/eye.png";
  $("#save").click(function(){
    
    var comment = $("#comment-field").val();
    var dataURL =  canvas.toDataURL('image/png');
    $.post("/pieces/edited", {img:dataURL, com:comment, pvid:<%= @piece_version.id %>}, function(){
      console.log('success');
      window.location = "/pieces/<%= @piece_version.piece.id =%>";
    })
    // window.location = dataURL;
    return false;
  });
});
  
  
</script>